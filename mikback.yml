---
- name: Backup Mikrotik and Push to GitHub
  hosts: mikrotik
  gather_facts: false
  vars:
    ansible_ssh_extra_args: '-o HostKeyAlgorithms=ssh-rsa'
    github_token: "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"
    owner: "masoudigram"
    repo: "ansible"
    backup_dir: "/home/msd"
  tasks:
    - name: Export
      ansible.builtin.shell: >-
        sshpass -p '{{ ansible_password }}' ssh -o StrictHostKeyChecking=no -o HostKeyAlgorithms=ssh-rsa  {{ ansible_user }}@{{ inventory_hostname }} /export
      register: export

    - name: Upload Export to GitHub
      uri:
        url: https://api.github.com/repos/{{ owner }}/{{ repo }}/contents/export.txt
        method: PUT
        headers:
          Authorization: "token {{ github_token }}"
          Content-Type: "application/json"
        body_format: json
        body: |
          {
            "message": "Adding MikroTik export",
            "content": "{{ export.stdout | b64encode }}"
          }
      register: github_upload

    - debug:
        var: github_upload
